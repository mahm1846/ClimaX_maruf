Bootstrap: docker
From: mcr.microsoft.com/azureml/openmpi4.1.0-cuda11.3-cudnn8-ubuntu20.04:latest
Stage: build

%post
# tags: https://catalog.ngc.nvidia.com/orgs/nvidia/containers/pytorch/tags?quick-deploy=false

DEBIAN_FRONTEND=noninteractive TZ=Australia/ACT \
apt-get update && apt-get install -y --allow-downgrades --allow-change-held-packages --no-install-recommends \
build-essential \
cmake \
g++-7 \
git \
gpg \
curl \
vim \
wget \
ca-certificates \
libjpeg-dev \
libpng-dev \
librdmacm1 \
libibverbs1 \
ibverbs-providers \
openssh-client \
openssh-server \
libsm6 \
libxext6 \
ffmpeg \
libfontconfig1 \
libxrender1 \
libgl1-mesa-glx && \
apt-get clean && rm -rf /var/lib/apt/lists/* && \
\
wget -v https://raw.githubusercontent.com/microsoft/ClimaX/main/docker/environment.yml && \
PIP_NO_CACHE_DIR=off && \
. /opt/miniconda/etc/profile.d/conda.sh && \
echo ". /opt/miniconda/etc/profile.d/conda.sh" >> $SINGULARITY_ENVIRONMENT && \
conda update conda && \
conda update -n base conda && \
conda env create -f environment.yml && \
CONDA_DEFAULT_ENV=climaX && \
conda activate climaX && \
git clone https://github.com/mahm1846/ClimaX_maruf.git && \
cd ClimaX_maruf && \
pip install -e . && \
apt-get autoremove && apt-get autoclean && conda clean -ay 


%environment
export CONDA_DEFAULT_ENV=climaX
export CONDA_PREFIX=/opt/miniconda/envs/climaX
export PATH=/opt/miniconda/envs/climaX/bin/:$PATH
%runscript
exec /bin/bash "$@"
%startscript
exec /bin/bash "$@"
